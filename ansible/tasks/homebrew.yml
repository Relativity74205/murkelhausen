- name: Install prereq packages
  apt:
    update_cache: true
    pkg:
      - build-essential
      - curl
      - file
      - git
      - procps
    state: latest
  become: True

- name: Clone Homebrew GitHub repo
  ansible.builtin.git:
    repo: https://github.com/Homebrew/brew
    dest: "/home/{{ user }}/.linuxbrew/Homebrew"
    version: master

- name: Create bin directory for brew
  ansible.builtin.file:
    path: "/home/{{ user }}/.linuxbrew/bin"
    state: directory

- name: Create a symbolic link for brew
  ansible.builtin.file:
    src: "/home/{{ user }}/.linuxbrew/Homebrew/bin/brew"
    dest: "/home/{{ user }}/.linuxbrew/bin/brew"
    state: link

- name: Add homebrew path to system-wide $PATH for zsh shell.
  lineinfile:
    path: '{{ item }}'
    line: "PATH=$PATH:/home/{{ user }}/.linuxbrew/bin"
    create: yes
  with_items:
    - '/home/{{ user }}/.profile'
    - '/home/{{ user }}/.bash_profile'
    - '/home/{{ user }}/.bashrc'
    - '/home/{{ user }}/.zprofile'
    - '/home/{{ user }}/.zshrc'

- name: Update homebrew
  community.general.homebrew:
    path: "/home/{{ user }}/.linuxbrew/bin"
    update_homebrew: yes

- name: add brew plugin to .zshrc
  include_role:
    name: add_plugin_to_zshrc
  vars:
    new_plugin: brew

- name: Install homebrew packages
  community.general.homebrew:
    path: "/home/{{ user }}/.linuxbrew/bin"
    name: '{{ item }}'
    state: latest
  loop: '{{ homebrew_packages }}'
